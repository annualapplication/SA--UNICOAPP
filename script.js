// Fully working login/register and application logic
const loginSection=document.getElementById('loginSection'),appSection=document.getElementById('appSection'),formTitle=document.getElementById('formTitle'),submitBtn=document.getElementById('submitBtn'),switchForm=document.getElementById('switchForm'),errorMsg=document.getElementById('errorMsg'),contactInput=document.getElementById('contactInput'),passwordInput=document.getElementById('passwordInput'),confirmPasswordInput=document.getElementById('confirmPasswordInput'),logoutBtn=document.getElementById('logoutBtn'),userContact=document.getElementById('userContact'),totalApsEl=document.getElementById('totalAps'),subjectsContainer=document.getElementById('subjectsContainer'),universitiesList=document.getElementById('universitiesList'),nsfasSection=document.getElementById('nsfasSection'),nsfasSelect=document.getElementById('nsfasSelect'),submitApplicationBtn=document.getElementById('submitApplicationBtn'),appErrorMsg=document.getElementById('appErrorMsg');let isLogin=!0;const subjects=["Mathematics","Physical Sciences","Life Sciences","English","IsiZulu","Accounting","Business Studies","Geography","Mathematical Literacy","Computer Applications Technology","Economics","History","Agricultural Sciences","Tourism","Visual Arts","Electrical Technology","Mechanical Technology","Life orientation"],provinces={Gauteng:["University of Pretoria","University of Johannesburg","Wits","TUT","Vaal University"],"KwaZulu-Natal":["UKZN","DUT","MUT","UNIZULU"]};function calculateAPS(e){return e>=80?7:e>=70?6:e>=60?5:e>=50?4:e>=40?3:e>=30?2:0}function buildSubjects(){subjectsContainer.innerHTML="",subjects.forEach(e=>{subjectsContainer.innerHTML+=`<label>${e} mark:</label><input type="number" min="0" max="100" data-subject="${e}" class="markInput">`} ),subjectsContainer.addEventListener("input",updateAPS)}function updateAPS(){const e=document.querySelectorAll(".markInput");let t=0;e.forEach(e=>{t+=calculateAPS(parseInt(e.value)||0)}),totalApsEl.textContent=t}function buildUniversities(){universitiesList.innerHTML="";for(const e in provinces)universitiesList.innerHTML+=`<div class="province-title">${e}</div>`,provinces[e].forEach(t=>{universitiesList.innerHTML+=`<label><input type="checkbox" class="uniCheckbox" value="${t}"> ${t}</label>`})}function isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function isValidWhatsApp(e){return/^0(6|7|8)\d{8}$/.test(e)}function isValidPassword(e){return e.length>=9&&/[A-Z]/.test(e)&&/[a-z]/.test(e)&&/\d/.test(e)&&/[^A-Za-z0-9]/.test(e)}function showError(e){errorMsg.textContent=e}function clearError(){errorMsg.textContent=""}function toggleMode(){clearError(),isLogin=!isLogin,formTitle.textContent=isLogin?"Login":"Register",submitBtn.textContent=isLogin?"Login":"Register",document.getElementById("confirmLabel").classList.toggle("hidden",isLogin),confirmPasswordInput.classList.toggle("hidden",isLogin)}submitBtn.onclick=()=>{clearError();const e=contactInput.value.trim(),t=passwordInput.value,n=confirmPasswordInput.value;if(!e||!t||!isLogin&&!n)return void showError("Fill in all fields");if(!isValidEmail(e)&&!isValidWhatsApp(e))return void showError("Enter valid Email or WhatsApp number");isLogin?login(e,t):isValidPassword(t)?t!==n?showError("Passwords do not match"):register(e,t):showError("Password must be 9+ chars, include uppercase, lowercase, number, and symbol")},switchForm.onclick=toggleMode,logoutBtn.onclick=()=>{location.reload()};function login(e,t){const n=JSON.parse(localStorage.getItem("users")||"{}");n[e]&&n[e].pass===t?n[e].verified?(appSection.classList.remove("hidden"),loginSection.classList.add("hidden"),userContact.textContent=e,buildSubjects(),buildUniversities(),nsfasSection.classList.remove("hidden")):showError("Please confirm your account using the link sent."):showError("Invalid credentials")}function register(e,t){const n=JSON.parse(localStorage.getItem("users")||"{}");if(n[e])return void showError("User already exists");const o=Math.random().toString(36).substring(2);n[e]={pass:t,verified:!1,token:o},localStorage.setItem("users",JSON.stringify(n)),isValidEmail(e)?sendConfirmationEmail(e,o):sendWhatsAppConfirmation(e),alert("Registration successful! Please confirm before logging in."),toggleMode()}function sendConfirmationEmail(e,t){const n=`${window.location.origin}?contact=${encodeURIComponent(e)}&token=${t}`;emailjs.send("service_2ytuwrb","template_dhpvtix",{to_email:e,confirmation_link:n}).then(()=>alert(`Confirmation email sent to ${e}`)).catch(()=>alert("Failed to send confirmation."))}function sendWhatsAppConfirmation(e){const t=`Welcome! Confirm profile: ${window.location.origin}?contact=${encodeURIComponent(e)}&token=confirm`;window.open(`https://wa.me/27683683912?text=${encodeURIComponent(t)}`,"_blank")}submitApplicationBtn.onclick=()=>{appErrorMsg.textContent="";const e=document.querySelectorAll(".markInput");let t=0,n=[];e.forEach(e=>{const o=e.value.trim();""!==o&&!isNaN(o)&&Number(o)>=0&&(t++,n.push(`${e.dataset.subject}: ${o}`))}),t<7?appErrorMsg.textContent="Enter marks for at least 7 subjects.":(()=>{const e=[];document.querySelectorAll(".uniCheckbox:checked").forEach(t=>e.push(t.value)),0===e.length?appErrorMsg.textContent="Select at least one institution.":""===nsfasSelect.value?appErrorMsg.textContent="Select NSFAS funding requirement.":(()=>{const t=`SA Application:\nApplicant: ${userContact.textContent}\nTotal APS: ${totalApsEl.textContent}\nSubjects:\n${n.join("\n")}\nInstitutions: ${e.join(", ")}\nNSFAS: ${nsfasSelect.value}`;window.open(`https://wa.me/27683683912?text=${encodeURIComponent(t)}`,"_blank"),alert("Application sent via WhatsApp!")})()})();window.onload=()=>{const e=new URLSearchParams(window.location.search),t=e.get("contact"),n=e.get("token");if(t&&n){const e=JSON.parse(localStorage.getItem("users")||"{}");e[t]&&(e[t].token===n||"confirm"===n)&&(e[t].verified=!0,e[t].token="",localStorage.setItem("users",JSON.stringify(e)),alert("Profile confirmed. You can log in."),window.history.replaceState({},document.title,window.location.pathname))}};
